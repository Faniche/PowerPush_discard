# 流程设计

服务端启动后 `7 x 24` 运行.

系统可同时供多人使用, 每个人对应一个 `group_id` , 每个 `group_id` 对应一个 `Map` , 包含 `device_id` 和设备`IP` 的映射关系.

```json
{
	"device_id_1": "ip_1",
	"device_id_2": "ip_2",
	"device_id_3": "ip_3",
	"device_id_4": "ip_4"
}
```

## 剪切板同步

### 一. 创建组

1. 在客户端生成一对非对称密钥, 将公钥放在服务器, 参考[ssh-keygen](https://www.ssh.com/ssh/keygen/).
2. 向服务器发送创建组的请求.
3. 服务器返回 `group_id` 和  `group_token` , 并将当前设备添加到组.

### 二. 加入组

1. 客户端利用 `group_id` 和  `group_token` 向服务器发送加入请求.
2. 服务器检查 `group_id` 和  `group_token` , 通过则将该设备添加到对应组, 不通过返回 `deny` .
3. 设备加入后服务器记录该设备的 `IP` , 在收到心跳后更新设备 `IP` .
4. 客户端每 `10` 秒发送一个心跳包, 服务器如果 1 分钟没有收到其中一个设备的心跳包, 则将该设备的 `IP` 设为空值, 随后的转发将不会发送给该设备, 直到重新收到该设备的心跳包, `IP` 不为空值再发送.
5. 通过 `group_id` 和 `device_id` 可以唯一标识一台设备, 在断网重新连接后可以自动同步剪切板内容.

### 三. 推送剪切板内容

服务器维护一个队列, 记录最近 `20` 次的剪切板记录.

客户端记录最近 `20` 次的剪切板记录.

```json
{
	"device_id_1": "clipboard-text-1",
	"device_id_2": "clipboard-text-2",
	"device_id_3": "clipboard-text-3",
	"device_id_4": "clipboard-text-4"
}
```

1. 其中一个客户端的剪切板内容改变后, 将新的内容发送至服务器.
2. 服务器收到后向该客户端发送确认.
3. 客户端 `3` 秒没收到确认则重新发送.

### 四. 转发剪切板内容

1. 服务器将新的内容发送至其他客户端.
2. 其他客户端在收到新的剪切板内容后发送确认并更新剪切板.

### 五. 拉取剪切板内容

1. 客户端 `10` 秒没收到新的剪切板内容则发送拉取的请求.
2. 如果没有新的内容, 服务器发回的数据为空值.

## 文件传输

